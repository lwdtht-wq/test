<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Singapore Religion Data</title>

<!-- D3.js -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

<style>
/* -------------------- GLOBAL STYLE -------------------- */
body {
    margin: 0;
    background: #0d0d0f;
    font-family: "Cinzel", "Georgia", serif;
    color: #f6d98a;
    overflow-x: hidden;
}
html { scroll-behavior: smooth; }

/* BUTTON */
button {
    padding: 10px 16px;
    border-radius: 8px;
    border: 1px solid #f6d98a;
    font-family: inherit;
    background: rgba(255,230,160,0.12);
    color: #f6d98a;
    cursor: pointer;
    margin: 5px;
    transition: 0.3s;
}
button:hover { background: rgba(255,230,160,0.3); }

/* SECTION */
.section {
    padding: 60px 60px;
    border-bottom: 1px solid rgba(255,220,150,0.12);
}
.panel {
    background: linear-gradient(145deg,#1a1a1d,#080808);
    border: 1px solid rgba(255,220,150,0.25);
    border-radius: 20px;
    padding: 30px;
    box-shadow: 
        0 0 25px rgba(255,215,130,0.2),
        inset 0 0 8px rgba(255,205,120,0.08);
    margin: 30px auto;
    max-width: 900px;
}

/* TITLE */
h1 {
    text-align: center;
    font-size: 40px;
    letter-spacing: 2px;
    margin: 40px 0 20px;
    color: #f6d98a;
    text-shadow: 0 0 15px rgba(255,230,160,0.4);
    animation: fadeInTitle 1.5s ease-out;
}
@keyframes fadeInTitle {
    0% { opacity: 0; transform: translateY(-20px); }
    100% { opacity: 1; transform: translateY(0); }
}
@keyframes fadeInPanel {
    0% { opacity: 0; transform: translateY(30px); }
    100% { opacity: 1; transform: translateY(0); }
}
.fade-panel { animation: fadeInPanel 1.2s ease-out; }

/* NAV */
nav {
    position: fixed;
    top: 0; left: 0; right: 0;
    background: rgba(10,10,12,0.9);
    backdrop-filter: blur(10px);
    padding: 12px 20px;
    border-bottom: 1px solid rgba(255,215,130,0.2);
    z-index: 999;
}
nav a {
    color: #f6d98a;
    margin: 0 18px;
    font-size: 16px;
    text-decoration: none;
    transition: 0.25s;
}
nav a:hover {
    color: #fff4d0;
    text-shadow: 0 0 8px #f6d98a;
}

/* TOOLTIP */
.tooltip {
    position: fixed;
    background: #1a1a1d;
    border: 1px solid #f6d98a;
    padding: 10px 12px;
    border-radius: 10px;
    pointer-events: none;
    color: #f6d98a;
    opacity: 0;
    transition: 0.2s;
}

/* MAP */
#map {
    height: 550px;
    border-radius: 15px;
}

/* TIMELINE DESCRIPTION BOX */
.timeline-box {
    background: rgba(255,215,130,0.07);
    border: 1px solid rgba(255,215,130,0.25);
    padding: 12px 20px;
    border-radius: 10px;
    margin: 12px 0;
}

/* MAGIC CURSOR */
#magic-cursor {
    position: fixed;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    pointer-events: none;
    background: radial-gradient(circle, #ffe9b0 0%, #d8b46a 70%, transparent 100%);
    mix-blend-mode: screen;
    transform: translate(-50%, -50%);
    z-index: 9999;
}

/* PARTICLE TRAIL */
.particle {
    position: fixed;
    width: 6px;
    height: 6px;
    background: radial-gradient(circle, #f6d98a, transparent);
    border-radius: 50%;
    pointer-events: none;
    opacity: 0.9;
    filter: blur(1px);
    z-index: 9998;
    animation: fadeOut 0.8s forwards;
}
@keyframes fadeOut {
  0% { opacity:1; transform: scale(1); }
  100% { opacity:0; transform: scale(0); }
}

/* GOLD DUST FALL */
.gold-dust {
    position: fixed;
    top: -10px;
    width: 5px;
    height: 5px;
    background: radial-gradient(circle, #ffebc2, #d6aa4c);
    border-radius: 50%;
    opacity: 0.8;
    pointer-events: none;
    animation: fall linear infinite;
}
@keyframes fall {
    0% { transform: translateY(0); opacity: 1; }
    100% { transform: translateY(120vh); opacity: 0; }
}
</style>
</head>

<body>

<!-- MAGIC CURSOR -->
<div id="magic-cursor"></div>

<script>
/* MAGIC CURSOR LOGIC */
document.addEventListener("mousemove", e => {
    const c = document.getElementById("magic-cursor");
    c.style.left = e.clientX + "px";
    c.style.top = e.clientY + "px";

    // particle
    const p = document.createElement("div");
    p.className = "particle";
    p.style.left = e.clientX + "px";
    p.style.top = e.clientY + "px";
    document.body.appendChild(p);
    setTimeout(()=>p.remove(), 800);
});

/* GOLD DUST RAIN */
function spawnDust() {
    const d = document.createElement("div");
    d.className = "gold-dust";
    d.style.left = Math.random() * 100 + "vw";
    d.style.animationDuration = (3 + Math.random()*4) + "s";
    document.body.appendChild(d);
    setTimeout(()=>d.remove(), 7000);
}
setInterval(spawnDust, 400);
</script>

<!-- NAVIGATION -->
<nav>
    <a href="#intro">Home</a>
    <a href="#pie">Religious Composition</a>
    <a href="#trend">Trends</a>
    <a href="#ethnicity">Ethnic Groups</a>
    <a href="#mapSection">Religious Map</a>
    <a href="#timeline">Festival Timeline</a>
</nav>

<!-- INTRO SECTION -->
<div id="intro" class="section">
    <h1>Singapore Religion Data</h1>
    <div class="panel fade-panel">
        <p style="font-size:18px; line-height:1.8;">
            Welcome to the Singapore Religion Visualization ‚Äî an immersive and interactive dashboard
            exploring:<br><br>
            ‚Ä¢ Religious composition (2020)<br>
            ‚Ä¢ 50-year historical trends<br>
            ‚Ä¢ Religion √ó ethnicity relationships<br>
            ‚Ä¢ Geographic distribution of worship sites<br>
            ‚Ä¢ Festival calendar<br><br>
            Designed in a mystical black-gold theme with animations, particles, glowing effects,
            smooth transitions, and magical cursor trails.
        </p>
    </div>
</div>
<!-- ========================================================= -->
<!-- ====================== PIE CHART SECTION ================= -->
<!-- ========================================================= -->
<div id="pie" class="section">
    <h1 class="fade-panel">Religious Composition (2020)</h1>

    <div class="panel fade-panel">
        <svg id="pieSVG" width="900" height="500"></svg>
        <div class="tooltip" id="pieTip"></div>
    </div>
</div>

<script>
/* ----------------------------- PIE CHART DATA ----------------------------- */
const pieData = [
  {religion:"Buddhism", val:31.1},
  {religion:"Taoism", val:8.8},
  {religion:"Christianity", val:18.9},
  {religion:"Islam", val:15.6},
  {religion:"Hinduism", val:5.0},
  {religion:"Other", val:0.6},
  {religion:"No Religion", val:20.0},
];

const PW = 900, PH = 500;
const cx = PW / 2, cy = PH / 2;
const radius = 150;

const pieSvg = d3.select("#pieSVG");
const pg = pieSvg.append("g").attr("transform", `translate(${cx},${cy})`);

const pieTip = d3.select("#pieTip");

/* ----------------------------- COLOR SCALE ----------------------------- */
const pieColor = d3.scaleOrdinal()
  .domain(pieData.map(d=>d.religion))
  .range([
    "#f6d98a","#d8b46a","#f1cc8f",
    "#c9a35a","#e8c377","#b89349","#ffdf9e"
]);

/* ----------------------------- GENERATORS ----------------------------- */
const pieGen = d3.pie().value(d => d.val);
const arc = d3.arc().innerRadius(70).outerRadius(radius);
const arcLine = d3.arc().innerRadius(radius+20).outerRadius(radius+20);

/* ----------------------------- DRAW SLICES ----------------------------- */
pg.selectAll("path")
  .data(pieGen(pieData))
  .enter()
  .append("path")
  .attr("fill", d => pieColor(d.data.religion))
  .attr("stroke", "#000")
  .attr("stroke-width", 0.4)
  .transition()
  .duration(1200)
  .attrTween("d", function(d){
    let i = d3.interpolate({startAngle:0,endAngle:0}, d);
    return t => arc(i(t));
  });

/* ----------------------------- HOVER INTERACTION ----------------------------- */
pg.selectAll("path")
  .on("mouseenter", function(event, d){
    d3.select(this)
      .transition().duration(150)
      .attr("transform", "scale(1.05)");

    pieTip.style("opacity", 1)
      .html(`<b>${d.data.religion}</b><br>${d.data.val}%`)
      .style("left", event.clientX + 20 + "px")
      .style("top", event.clientY - 10 + "px");
  })
  .on("mouseleave", function(){
    d3.select(this)
      .transition().duration(150)
      .attr("transform", "scale(1)");
    pieTip.style("opacity", 0);
  });

/* ----------------------------- CLICK EXPLODE ----------------------------- */
pg.selectAll("path")
  .on("click", function(event, d){
    const off = 15;
    const mid = (d.startAngle + d.endAngle) / 2;
    const dx = Math.cos(mid) * off;
    const dy = Math.sin(mid) * off;

    d3.select(this)
      .transition().duration(250)
      .attr("transform", `translate(${dx},${dy})`);
  });

/* ----------------------------- LABELS (NO OVERLAP) ----------------------------- */
let labels = pieGen(pieData).map(d=>{
  let [lx, ly] = arcLine.centroid(d);
  const side = lx > 0 ? "right" : "left";
  return {...d, side, rawX: lx, rawY: ly};
});

let left = labels.filter(d => d.side === "left");
let right = labels.filter(d => d.side === "right");

left.sort((a,b)=>a.rawY - b.rawY);
right.sort((a,b)=>a.rawY - b.rawY);

function distribute(list, topY, bottomY){
  const gap = (bottomY - topY) / (list.length - 1 || 1);
  list.forEach((d,i)=>d.finalY = topY + gap * i);
}
distribute(left, -160, 160);
distribute(right, -160, 160);

labels = [...left, ...right];

/* Polyline connections */
pieSvg.append("g")
  .selectAll("polyline")
  .data(labels)
  .enter()
  .append("polyline")
  .attr("stroke", "#f6d98a")
  .attr("stroke-width", 1.3)
  .attr("fill", "none")
  .attr("points", d => {
    const p1 = arc.centroid(d).map((p,i)=> i? p+cy : p+cx);
    const p2 = arcLine.centroid(d).map((p,i)=> i? p+cy : p+cx);
    const p3 = [
      d.side === "right" ? cx + 280 : cx - 280,
      cy + d.finalY
    ];
    return [p1, p2, p3];
  });

/* Labels text */
pieSvg.append("g")
  .selectAll("text")
  .data(labels)
  .enter()
  .append("text")
  .attr("x", d => d.side === "right" ? cx + 300 : cx - 300)
  .attr("y", d => cy + d.finalY + 5)
  .attr("text-anchor", d => d.side === "right" ? "start" : "end")
  .attr("font-size", 15)
  .attr("fill", "#f6d98a")
  .text(d => `${d.data.religion}: ${d.data.val}%`);
</script>


<!-- ========================================================= -->
<!-- ====================== TREND LINE SECTION ================ -->
<!-- ========================================================= -->
<div id="trend" class="section">
    <h1 class="fade-panel">Religious Trend (1965‚Äì2020)</h1>

    <div class="panel fade-panel">
        <svg id="trendSVG" width="600" height="400"></svg>
        <div class="tooltip" id="trendTip"></div>
    </div>
</div>

<script>
/* Trend data */
const trendData = [
  {year:1965, buddhist:10, christian:5, islam:12},
  {year:1980, buddhist:18, christian:8, islam:14},
  {year:1990, buddhist:24, christian:12, islam:15},
  {year:2000, buddhist:30, christian:17, islam:14},
  {year:2010, buddhist:33, christian:19, islam:15},
  {year:2020, buddhist:31, christian:18.9, islam:15.6}
];

const trendColors = {
  buddhist:"#f6d98a",
  christian:"#d8b46a",
  islam:"#ffdf9e"
};

const tsvg = d3.select("#trendSVG");
const tw = 600, th = 400;
const tm = {top:40,right:80,bottom:40,left:50};

const tx = d3.scaleLinear()
  .domain(d3.extent(trendData, d=>d.year))
  .range([tm.left, tw-tm.right]);

const ty = d3.scaleLinear()
  .domain([0,40])
  .range([th-tm.bottom, tm.top]);

/* Axes */
tsvg.append("g")
  .attr("transform",`translate(0,${th-tm.bottom})`)
  .call(d3.axisBottom(tx).tickFormat(d3.format("d")))
  .selectAll("text").attr("fill","#f6d98a");

tsvg.append("g")
  .attr("transform",`translate(${tm.left},0)`)
  .call(d3.axisLeft(ty))
  .selectAll("text").attr("fill","#f6d98a");

/* Tooltip */
const trendTip = d3.select("#trendTip");

/* Lines */
["buddhist","christian","islam"].forEach(key=>{
  const line = d3.line()
      .x(d=>tx(d.year))
      .y(d=>ty(d[key]));

  const path = tsvg.append("path")
      .datum(trendData)
      .attr("fill","none")
      .attr("stroke",trendColors[key])
      .attr("stroke-width",2)
      .attr("d",line);

  const length = path.node().getTotalLength();

  /* animation */
  path
    .attr("stroke-dasharray",length)
    .attr("stroke-dashoffset",length)
    .transition()
    .duration(1500)
    .ease(d3.easeCubic)
    .attr("stroke-dashoffset",0);

  /* dots */
  const dots = tsvg.selectAll(`.dot-${key}`)
      .data(trendData)
      .enter()
      .append("circle")
      .attr("class",`dot-${key}`)
      .attr("cx",d=>tx(d.year))
      .attr("cy",d=>ty(d[key]))
      .attr("r",4)
      .attr("fill",trendColors[key]);

  dots.on("mouseenter", function(e,d){
      d3.select(this).transition().duration(120).attr("r",7).attr("fill","#fff6dc");

      trendTip.style("opacity",1)
        .html(`<b>${key}</b>: ${d[key]}%`)
        .style("left",(e.clientX+15)+"px")
        .style("top",(e.clientY-10)+"px");
  });

  dots.on("mouseleave", function(){
      d3.select(this).transition().duration(120).attr("r",4).attr("fill",trendColors[key]);
      trendTip.style("opacity",0);
  });

  /* Legend click toggle */
  tsvg.append("text")
      .attr("x", tw-tm.right+10)
      .attr("y", tm.top + ["buddhist","christian","islam"].indexOf(key)*30)
      .text(key.charAt(0).toUpperCase()+key.slice(1))
      .attr("fill", trendColors[key])
      .style("cursor","pointer")
      .on("click", ()=>{
          const show = path.style("opacity") == 1 ? 0 : 1;

          path.transition().duration(600).style("opacity",show);
          dots.transition().duration(600).style("opacity",show);

          if(show == 1){
              path
                .attr("stroke-dashoffset",length)
                .transition().duration(1500)
                .attr("stroke-dashoffset",0);
          }
      });
});
</script>
<!-- ========================================================= -->
<!-- ====================== ETHNICITY STACK ================== -->
<!-- ========================================================= -->
<div id="ethnicity" class="section">
    <h1 class="fade-panel">Ethnicity √ó Religion (Census 2020)</h1>

    <div class="panel fade-panel">
        <svg id="stackSvg" width="760" height="420"></svg>
        <div class="tooltip" id="stackTip"></div>
    </div>
</div>

<script>
/* ------------------------------ DATA ------------------------------ */
const raceData = [
  {race:"Chinese", Buddhist:33, Christian:20, Islam:1, Hindu:0.4, None:20},
  {race:"Malay",   Buddhist:1,  Christian:10, Islam:84, Hindu:0.3, None:1},
  {race:"Indian",  Buddhist:5,  Christian:19, Islam:24, Hindu:55, None:2},
];

const groups = ["Buddhist", "Christian", "Islam", "Hindu", "None"];

const colors = {
  Buddhist:"#f6d98a",
  Christian:"#d8b46a",
  Islam:"#ffdf9e",
  Hindu:"#e8c377",
  None:"#c9a35a"
};

/* ------------------------------ SVG LAYOUT ------------------------------ */
const svgE = d3.select("#stackSvg");
const EW = 760, EH = 420;
const Em = {top:40, right:40, bottom:40, left:90};

const ex = d3.scaleLinear().domain([0,100]).range([Em.left, EW - Em.right]);
const ey = d3.scaleBand().domain(raceData.map(d => d.race))
      .range([Em.top, EH - Em.bottom]).padding(0.4);

/* ------------------------------ AXES ------------------------------ */
svgE.append("g")
  .attr("transform", `translate(0,${EH - Em.bottom})`)
  .call(d3.axisBottom(ex))
  .selectAll("text").attr("fill","#f6d98a");

svgE.append("g")
  .attr("transform", `translate(${Em.left},0)`)
  .call(d3.axisLeft(ey))
  .selectAll("text").attr("fill","#f6d98a");

/* ------------------------------ STACKED DATA ------------------------------ */
const stackBar = d3.stack().keys(groups);
const layers = stackBar(raceData);

/* ------------------------------ TOOLTIP ------------------------------ */
const tipE = d3.select("#stackTip");

/* ------------------------------ DRAW BARS ------------------------------ */
layers.forEach(layer => {
  svgE.selectAll(`rect.layer-${layer.key}`)
    .data(layer)
    .enter()
    .append("rect")
    .attr("class", `layer-${layer.key}`)
    .attr("x", d => ex(d[0]))
    .attr("y", d => ey(d.data.race))
    .attr("height", ey.bandwidth())
    .attr("width", 0)
    .attr("fill", colors[layer.key])
    .transition()
    .duration(900)
    .attr("width", d => ex(d[1]) - ex(d[0]));
});

/* ------------------------------ HOVER INTERACTION ------------------------------ */
svgE.selectAll("rect")
  .on("mouseenter", function(event, d){
    const religion = Object.keys(d.data).find(key =>
      d.data[key] === d[1]-d[0]
    );

    d3.select(this)
      .transition().duration(150)
      .attr("transform", "scale(1.03)");

    tipE.style("opacity",1)
      .html(`
        <b>${d.data.race}</b><br>
        ${religion}: ${(d[1]-d[0]).toFixed(1)}%
      `)
      .style("left", event.clientX + 15 + "px")
      .style("top", event.clientY + "px");
  })
  .on("mouseleave", function(){
    d3.select(this)
      .transition().duration(150)
      .attr("transform", "scale(1)");

    tipE.style("opacity",0);
  });

/* ------------------------------ LEGEND INTERACTION ------------------------------ */
groups.forEach((key, i) => {
  svgE.append("text")
    .attr("x", EW - 120)
    .attr("y", Em.top + i*25)
    .attr("fill", colors[key])
    .text(key)
    .style("cursor","pointer")
    .on("click", ()=>{

      const rects = svgE.selectAll(`.layer-${key}`);
      const current = rects.style("opacity") == 1 ? 0 : 1;

      // Fade toggle
      rects.transition().duration(400).style("opacity", current);

      // Bring animation back when turned ON
      if(current == 1){
        rects
          .attr("width",0)
          .transition()
          .duration(900)
          .attr("width", d => ex(d[1]) - ex(d[0]));
      }
    });
});
</script>
<!-- ========================================================= -->
<!-- ====================== MAP SECTION ====================== -->
<!-- ========================================================= -->
<div id="mapSection" class="section">
    <h1 class="gold-glow-title">Map of Major Religious Sites</h1>

    <div class="panel fade-panel" style="text-align:center; margin-bottom:25px;">
        <button onclick="loadMarkers(null)">All</button>
        <button onclick="loadMarkers('temple')">Temples</button>
        <button onclick="loadMarkers('mosque')">Mosques</button>
        <button onclick="loadMarkers('church')">Churches</button>
        <button onclick="loadMarkers('hindu')">Hindu Temples</button>
    </div>

    <div class="panel fade-panel">
        <div id="map" style="height:550px; border-radius:15px;"></div>
    </div>
</div>

<script>
/* =========================================================
   LEAFLET MAP ‚Äì FINAL FIXED VERSION
========================================================= */

// Create map instance (NO duplicate variable names)
let sgMap = L.map("map", { scrollWheelZoom: true }).setView([1.3521, 103.8198], 12);

// Safe tile layer (never fails)
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
}).addTo(sgMap);

// Icons
const iconHTML_map = {
  temple: "üî±",
  mosque: "üïå",
  church: "‚õ™",
  hindu: "üïâÔ∏è",
};

function createIconMap(type) {
  return L.divIcon({
    className: "",
    html: `<div style="
        transform: scale(0);
        animation: popIn 0.4s forwards;
        font-size: 32px;
    ">${iconHTML_map[type]}</div>`
  });
}

// pop-in animation
const popAnim = document.createElement("style");
popAnim.innerHTML = `
@keyframes popIn {
  0% { transform: scale(0); opacity:0; }
  60% { transform: scale(1.5); opacity:1; }
  100% { transform: scale(1); }
}`;
document.head.appendChild(popAnim);

// Religious sites
const siteList = [
  {name:"Buddha Tooth Relic Temple", type:"temple", lat:1.2814, lng:103.8443},
  {name:"Thian Hock Keng", type:"temple", lat:1.2804, lng:103.8480},
  {name:"Sultan Mosque", type:"mosque", lat:1.3028, lng:103.8591},
  {name:"St Andrew‚Äôs Cathedral", type:"church", lat:1.2924, lng:103.8525},
  {name:"Sri Mariamman Temple", type:"hindu", lat:1.2831, lng:103.8447},
  {name:"Sri Veeramakaliamman Temple", type:"hindu", lat:1.3066, lng:103.8497},
];

let sgMarkers = [];

// Load markers with filter
function loadMarkers(filter = null) {

  // remove existing
  sgMarkers.forEach(m => sgMap.removeLayer(m));
  sgMarkers = [];

  siteList.forEach(site => {
    if (filter && site.type !== filter) return;

    let marker = L.marker([site.lat, site.lng], {
        icon: createIconMap(site.type)
    })
    .addTo(sgMap)
    .bindPopup(`
      <b>${site.name}</b><br>
      <span style="opacity:0.7">${site.type}</span>
    `);

    // Hover to open popup
    marker.on("mouseover", () => marker.openPopup());
    marker.on("mouseout", () => marker.closePopup());

    sgMarkers.push(marker);
  });
}

loadMarkers(); // default load all
</script>

<!-- ========================================================= -->
<!-- ====================== ENDING SECTION =================== -->
<!-- ========================================================= -->
<div class="section" style="padding:80px 60px; text-align:center;">
    <h1 class="gold-glow-title">Thank You for Exploring</h1>

    <p style="font-size:20px; max-width:700px; margin:auto; line-height:1.8; margin-top:20px;">
        This interactive dashboard visualizes Singapore‚Äôs rich religious diversity ‚Äî
        from population composition, ethnic patterns, historical trends,
        sacred landmarks, to festival celebrations.
        <br><br>
        May this journey inspire deeper appreciation of
        harmony, culture, and the spiritual mosaic that shapes Singapore.
    </p>
</div>
</body>
</html>
